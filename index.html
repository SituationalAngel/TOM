<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Military Tactical Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    html, body, #map {
      height: 100%; margin: 0;
      background: #111; font-family: monospace; color: #0ff;
    }
    .leaflet-container { background: #111; }
    .military-label {
      font-size: 12px; background: rgba(0,0,0,0.6);
      padding: 2px 4px; color: #0ff; cursor: pointer;
      white-space: nowrap; max-width: 120px;
      overflow: hidden; text-overflow: ellipsis;
    }
    .leaflet-popup-content-wrapper {
      background: rgba(0,0,0,0.85) !important;
      border-radius: 0 !important; border: none !important;
      box-shadow: none !important;
      font-family: monospace; font-size: 12px; color: #0ff;
    }
    .leaflet-popup-tip { display: none; }

    button.toggle-btn {
      position: absolute;
      background: rgba(0,0,0,0.75);
      color: #0ff; font-family: monospace;
      padding: 6px 12px; cursor: pointer;
      border: none; outline: none;
      font-size: 14px; z-index: 1100;
      user-select: none; border-radius: 0;
      transition: background 0.2s;
    }
    .toggle-btn:hover { background: rgba(0,255,255,0.15); }
    .activeToggle {
      background: #0ff; color: #000; font-weight: bold;
    }
    #planeToggle { top: 10px; right: 10px; }
    #triangToggle { top: 10px; left: 10px; }
    #rulerToggle { top: 50px; left: 10px; }

    #infoBox, #angleBox, #rulerBox {
      position: absolute; background: rgba(0,0,0,0.75);
      color: #0ff; font-size: 13px;
      padding: 6px 8px; max-width: 260px;
      pointer-events: none; border-radius: 0;
      font-family: monospace; line-height: 1.3em;
      z-index: 1000;
    }
    #infoBox { top: 90px; left: 10px; }
    #angleBox { top: 150px; left: 10px; }
    #rulerBox { bottom: 10px; left: 10px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="planeToggle" class="toggle-btn activeToggle">Planes ON</button>
  <button id="triangToggle" class="toggle-btn">Triangulate OFF</button>
  <button id="rulerToggle" class="toggle-btn">Ruler OFF</button>

  <div id="infoBox">Click "Triangulate ON" and place 3 points</div>
  <div id="angleBox"></div>
  <div id="rulerBox">Ruler: inactive</div>

  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    const map = L.map('map', { center: [39.5, -98.35], zoom: 3, zoomControl: true });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; CARTO', subdomains: 'abcd', maxZoom: 19
    }).addTo(map);

    const branchColors = { 'Army':'#0ff','Marines':'#f50','Air Force':'#19f','Navy':'#fa0','Special Ops':'#2f2','Classified':'#f9c','Joint':'#0ff' };
    const baseSymbol = '✈';

    function addBase(lat,lng,code,branch,history){
      const c=branchColors[branch]||'#ccc';
      const mk=L.marker([lat,lng],{
        icon:L.divIcon({
          className:'military-label',
          html:`<span style="color:${c};">${baseSymbol} ${code}</span>`,
          iconSize:[110,30],iconAnchor:[55,15]
        })
      }).addTo(map);
      mk.bindPopup(`<b>${code}</b><br><em>${branch}</em><br><br>${history}`);
    }

    // Examples of global bases
    addBase(38.876,-77.0164,'Pentagon','Joint','HQ of US DoD');
    addBase(51.151,7.071,'Ramstein','Air Force','Major USAF EU hub');
    addBase(35.8,14.5,'NSA Naples','Navy','Mediterranean command');
    addBase(24.628,54.444,'Al Dhafra','Air Force','Strategic MEF base');
    addBase(4.0,73.5,'Camp Lemonnier','Special Ops','Horn of Africa SO HQ');
    // ...add more here...

    // Plane tracking
    const planeIcon = L.icon({ iconUrl:'https://cdn-icons-png.flaticon.com/512/1783/1783356.png', iconSize:[24,24], iconAnchor:[12,12], popupAnchor:[0,-12] });
    let planes={}, flightsInterval=null, planesActive=true;

    async function fetchLiveFlights(){
      if(!planesActive) return;
      try {
        const res = await fetch('http://localhost:3001/api/flights');
        if(!res.ok) throw new Error('Bad response');
        const data = await res.json();
        const ids = new Set();
        data.states.forEach(s=>{
          const [id,call,,,,lon,lat,alt]=s;
          if(lat==null||lon==null) return;
          ids.add(id);
          const cs = call.trim()||'Unknown';
          if(planes[id]){
            planes[id].setLatLng([lat,lon]).setPopupContent(`<b>${cs}</b><br>Alt: ${Math.round(alt)}m`);
          } else {
            planes[id]=L.marker([lat,lon],{icon:planeIcon})
              .bindPopup(`<b>${cs}</b><br>Alt: ${Math.round(alt)}m`).addTo(map);
          }
        });
        Object.keys(planes).forEach(id=>{
          if(!ids.has(id)){ map.removeLayer(planes[id]); delete planes[id]; }
        });
      } catch(e){ console.error('Flight fetch error',e); }
    }

    function startFlights(){ if(flightsInterval) clearInterval(flightsInterval); flightsInterval=setInterval(fetchLiveFlights,15000); fetchLiveFlights(); }
    function stopFlights(){ if(flightsInterval) clearInterval(flightsInterval); flightsInterval=null; Object.values(planes).forEach(m=>map.removeLayer(m)); planes={}; }

    document.getElementById('planeToggle').addEventListener('click', e=>{
      planesActive=!planesActive;
      if(planesActive){ startFlights(); e.target.textContent='Planes ON'; e.target.classList.add('activeToggle'); }
      else { stopFlights(); e.target.textContent='Planes OFF'; e.target.classList.remove('activeToggle'); }
    });

    startFlights();

    // Triangulate & Ruler
    function distKm(a,b){
      const R=6371, rad=x=>x*Math.PI/180;
      const dlat=rad(b.lat-a.lat), dlon=rad(b.lng-a.lng);
      const la=rad(a.lat), lb=rad(b.lat);
      const x = Math.sin(dlat/2)**2 + Math.cos(la)*Math.cos(lb)*Math.sin(dlon/2)**2;
      return R*2*Math.atan2(Math.sqrt(x), Math.sqrt(1-x));
    }
    function angle(A,B,C){
      const toV=(p,q)=>({x:q.lng-p.lng, y:q.lat-p.lat});
      const u=toV(B,A), v=toV(B,C);
      const dot=u.x*v.x + u.y*v.y;
      const mag=(w)=>Math.sqrt(w.x*w.x+w.y*w.y);
      return Math.acos(dot/(mag(u)*mag(v)))*180/Math.PI;
    }

    let triActive=false, rulerActive=false;
    const infoBox=document.getElementById('infoBox'),
          angleBox=document.getElementById('angleBox'),
          rulerBox=document.getElementById('rulerBox');
    let triPts=[], triMk=[], triLn=[];
    let rulerStart=null, rulerLn=null;

    function clearTri(){ triMk.forEach(m=>map.removeLayer(m)); triLn.forEach(l=>map.removeLayer(l)); triMk=triLn=[]; triPts=[]; infoBox.textContent='Click 3 points'; angleBox.textContent=''; }
    function clearRul(){ if(rulerLn) map.removeLayer(rulerLn); rulerLn=null; rulerStart=null; rulerBox.textContent='Ruler: inactive'; }
    function clearAll(){ clearTri(); clearRul(); }

    function drawTriangle(){
      triLn.push(L.polyline([triPts[0],triPts[1]],{color:'#0ff'}).addTo(map));
      triLn.push(L.polyline([triPts[1],triPts[2]],{color:'#0ff'}).addTo(map));
      triLn.push(L.polyline([triPts[2],triPts[0]],{color:'#0ff'}).addTo(map));
    }

    function updTri(){
      if(triPts.length!==3) return;
      const [A,B,C]=triPts;
      const dAB=distKm(A,B).toFixed(1), dBC=distKm(B,C).toFixed(1), dCA=distKm(C,A).toFixed(1);
      const aA=angle(B,A,C).toFixed(1), aB=angle(A,B,C).toFixed(1), aC=angle(A,C,B).toFixed(1);
      infoBox.innerHTML=`<b>Sides (km)</b><br>A-B:${dAB}, B-C:${dBC}, C-A:${dCA}`;
      angleBox.innerHTML=`<b>Angles (°)</b><br>∠A:${aA}, ∠B:${aB}, ∠C:${aC}`;
    }

    map.on('click', e=>{
      if(triActive){
        if(triPts.length===3) clearTri();
        triPts.push(e.latlng);
        triMk.push(L.circleMarker(e.latlng,{radius:6,color:'#0ff',fillColor:'#0ff',fillOpacity:0.7}).addTo(map));
        if(triPts.length===3){ drawTriangle(); updTri(); }
        else infoBox.textContent=`${3-triPts.length} clicks left`;
        if(rulerActive){ clearRul(); rulerActive=false; document.getElementById('rulerToggle').classList.remove('activeToggle'); }
      }
      else if(rulerActive){
        if(!rulerStart){
          rulerStart=e.latlng;
          rulerBox.textContent='Ruler: click end';
        } else {
          const end=e.latlng;
          rulerLn=L.polyline([rulerStart,end],{color:'#0ff',dashArray:'5,8'}).addTo(map);
          rulerBox.textContent=`Ruler: ${distKm(rulerStart,end).toFixed(2)} km`;
          rulerStart=null;
        }
        if(triActive){ clearTri(); triActive=false; document.getElementById('triangToggle').classList.remove('activeToggle'); }
      }
    });

    document.getElementById('triangToggle').addEventListener('click',e=>{
      triActive=!triActive;
      if(triActive){
        rulerActive=false; clearRul();
        document.getElementById('rulerToggle').classList.remove('activeToggle');
      }
      e.target.classList.toggle('activeToggle', triActive);
      e.target.textContent = triActive ? 'Triangulate ON' : 'Triangulate OFF';
    });

    document.getElementById('rulerToggle').addEventListener('click',e=>{
      rulerActive=!rulerActive;
      if(rulerActive){
        triActive=false; clearTri();
        document.getElementById('triangToggle').classList.remove('activeToggle');
      }
      e.target.classList.toggle('activeToggle', rulerActive);
      e.target.textContent = rulerActive ? 'Ruler ON' : 'Ruler OFF';
    });

    document.addEventListener('keydown',e=>{
      if(e.key.toLowerCase()==='r') clearAll();
    });
  </script>
</body>
</html>
