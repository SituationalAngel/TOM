<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Military Base Map - Official Code Names & Regions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      background: #1a1a1a;
      font-family: monospace;
      color: #0ff;
    }

    .leaflet-container {
      background: #1a1a1a;
    }

    .military-label {
      font-size: 12px;
      background: rgba(0,0,0,0.6);
      padding: 2px 4px;
      color: #0ff;
      white-space: nowrap;
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      user-select: none;
    }

    .zoom-home {
      background: rgba(0, 0, 0, 0.8);
      color: #0ff;
      font-size: 16px;
      line-height: 20px;
      padding: 4px;
      cursor: pointer;
      user-select: none;
    }

    /* Remove rounded corners & border from Leaflet popups */
    .leaflet-popup-content-wrapper {
      background: rgba(0, 0, 0, 0.85);
      color: #0ff;
      font-family: monospace;
      font-size: 12px;
      padding: 8px;
      border-radius: 0 !important;
      border: none !important;
      box-shadow: none !important;
    }

    .leaflet-popup-tip {
      display: none;
    }

    /* Info boxes for triangulation & ruler */
    #infoBox, #angleBox, #rulerBox {
      position: absolute;
      background: rgba(0,0,0,0.75);
      color: #0ff;
      font-size: 14px;
      padding: 8px 10px;
      max-width: 320px;
      pointer-events: none;
      border-radius: 0;
      z-index: 1000;
      user-select: none;
      font-family: monospace;
      line-height: 1.2em;
    }
    #infoBox {
      top: 50px;
      left: 10px;
    }
    #angleBox {
      top: 130px;
      left: 10px;
    }
    #rulerBox {
      bottom: 10px;
      left: 10px;
      max-width: 320px;
    }

    /* Toggle buttons */
    #planeToggle, #triangToggle, #rulerToggle {
      position: absolute;
      background: rgba(0,0,0,0.75);
      color: #0ff;
      font-family: monospace;
      padding: 8px 14px;
      cursor: pointer;
      user-select: none;
      font-size: 14px;
      border: none;
      outline: none;
      z-index: 1100;
      transition: background 0.3s ease;
      border-radius: 0;
    }
    #planeToggle {
      top: 10px;
      right: 10px;
    }
    #triangToggle {
      top: 10px;
      left: 10px;
    }
    #rulerToggle {
      top: 50px;
      left: 10px;
    }

    #planeToggle:hover, #triangToggle:hover, #rulerToggle:hover {
      background: rgba(0,255,255,0.15);
    }

    /* Active button highlight */
    .activeToggle {
      background: #00ffff;
      color: #000;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <button id="planeToggle" class="activeToggle">Planes ON</button>
  <button id="triangToggle">Triangulate OFF</button>
  <button id="rulerToggle">Ruler OFF</button>

  <div id="infoBox">Click 3 points to triangulate</div>
  <div id="angleBox"></div>
  <div id="rulerBox">Ruler: inactive</div>

  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    const map = L.map('map', {
      center: [39.5, -98.35],
      zoom: 3,
      zoomControl: true
    });

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; CARTO',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map);

    const branchColors = {
      'Army': '#00ffff',
      'Marines': '#ff4500',
      'Air Force': '#1e90ff',
      'Navy': '#ffa500',
      'Special Ops': '#32cd32',
      'Classified': '#ff69b4',
      'Joint': '#00ffff'
    };

    const baseSymbol = '✈';

    function addBase(lat, lng, codeName, branch, history) {
      const color = branchColors[branch] || '#ccc';
      const marker = L.marker([lat, lng], {
        icon: L.divIcon({
          className: 'military-label',
          html: `<span style="color:${color};">${baseSymbol} ${codeName}</span>`,
          iconSize: [110, 30],
          iconAnchor: [55, 15]
        })
      }).addTo(map);
      const popupContent = `<strong>${codeName}</strong><br><em>${branch}</em><br><br>${history}`;
      marker.bindPopup(popupContent);
    }

    // Bases
    addBase(38.876, -77.0164, 'The Pentagon', 'Joint', 'The Pentagon is the headquarters of the United States Department of Defense, located in Arlington, Virginia.');
    addBase(35.139, -79.006, 'Liberty', 'Army', 'Liberty (formerly Fort Bragg) is one of the largest military installations in the world, home to airborne and special operations forces.');
    addBase(31.1346, -97.7800, 'Cavazos', 'Army', 'Cavazos (formerly Fort Hood) is a major U.S. Army post in Texas, housing armored and aviation units.');
    addBase(37.9, -85.956, 'Knox', 'Army', 'Knox is the primary training base for the U.S. Army\'s armored forces, located in Kentucky.');
    addBase(39.108, -76.745, 'Meade', 'Army', 'Fort Meade hosts the NSA and U.S. Cyber Command, playing a crucial role in cyber warfare and intelligence.');
    addBase(33.3, -117.3, 'Pendleton', 'Marines', 'Camp Pendleton is the major West Coast base of the U.S. Marine Corps in California.');
    addBase(32.6831, -117.16, 'Miramar', 'Marines', 'MCAS Miramar serves Marine aviation and is known as "Fightertown USA".');
    addBase(39.8262, -84.0611, 'Wright-Patterson', 'Air Force', 'Wright-Patterson AFB is a major Air Force base and center for research and development.');
    addBase(38.8106, -77.1203, 'Anacostia-Bolling', 'Joint', 'Joint Base Anacostia–Bolling combines Air Force and Navy facilities near Washington D.C.');
    addBase(36.945, -76.305, 'Norfolk', 'Navy', 'Naval Station Norfolk is the world\'s largest naval base and a hub for Atlantic fleet operations.');
    addBase(47.11, -122.57, 'Lewis-McChord', 'Joint', 'Joint Base Lewis–McChord is a major Army and Air Force installation near Tacoma, Washington.');
    addBase(24.628, 54.444, 'Al Dhafra', 'Air Force', 'Al Dhafra Air Base in UAE is a strategic U.S. Air Force base in the Middle East.');
    addBase(35.8, 14.5, 'NSA Naples', 'Navy', 'Naval Support Activity Naples is a key U.S. naval base in Italy supporting Mediterranean operations.');
    addBase(51.151, 7.071, 'Ramstein', 'Air Force', 'Ramstein Air Base in Germany is a major hub for U.S. Air Forces in Europe.');
    addBase(4.0, 73.5, 'Camp Lemonnier', 'Special Ops', 'Camp Lemonnier is the primary U.S. military base in Africa, hosting special operations forces.');
    addBase(42.733, 141.659, 'Misawa', 'Air Force', 'Misawa Air Base in Japan supports U.S. Air Force operations in the Pacific region.');
    addBase(-15.383, 28.283, 'Guantanamo Bay', 'Navy', 'Naval Station Guantanamo Bay is a U.S. naval base in Cuba, known for its detention facilities.');
    addBase(60.815, -147.855, 'Elmendorf-Richardson', 'Joint', 'Joint Base Elmendorf-Richardson combines Army and Air Force presence near Anchorage, Alaska.');
    addBase(5.35, 100.28, 'Kedah', 'Classified', 'Classified operations reportedly occur here in Southeast Asia.');

    // Live Flight Tracking
    const planeIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/1783/1783356.png',
      iconSize: [24, 24],
      iconAnchor: [12, 12],
      popupAnchor: [0, -12]
    });

let planes = {};
let flightsInterval = null;
let planesActive = true;

async function fetchLiveFlights() {
  if (!planesActive) return;
  try {
    const response = await fetch('https://opensky-network.org/api/states/all');
    if (!response.ok) throw new Error('Failed to fetch flight data');
    const data = await response.json();
    if (!data.states) return;

    const currentPlaneIDs = new Set();

    data.states.forEach(state => {
      const [icao24, callsignRaw, origin_country, , , lon, lat, baro_altitude] = state;
      if (lat === null || lon === null) return;
      const callsign = callsignRaw ? callsignRaw.trim() : 'Unknown';
      currentPlaneIDs.add(icao24);

      if (planes[icao24]) {
        planes[icao24].setLatLng([lat, lon]);
        planes[icao24].setPopupContent(
          `<b>${callsign}</b><br>Country: ${origin_country}<br>Altitude: ${Math.round(baro_altitude || 0)} m`
        );
      } else {
        const marker = L.marker([lat, lon], { icon: planeIcon })
          .bindPopup(
            `<b>${callsign}</b><br>Country: ${origin_country}<br>Altitude: ${Math.round(baro_altitude || 0)} m`
          )
          .addTo(map);
        planes[icao24] = marker;
      }
    });

    for (const id in planes) {
      if (!currentPlaneIDs.has(id)) {
        map.removeLayer(planes[id]);
        delete planes[id];
      }
    }
  } catch (err) {
    console.error('Live flight data fetch error:', err);
  }
}

function startFlightsInterval() {
  if (flightsInterval) clearInterval(flightsInterval);
  flightsInterval = setInterval(fetchLiveFlights, 15000);
  fetchLiveFlights();
}

function stopFlightsInterval() {
  if (flightsInterval) {
    clearInterval(flightsInterval);
    flightsInterval = null;
  }
  for (const id in planes) {
    map.removeLayer(planes[id]);
  }
  planes = {};
}

const planeToggleBtn = document.getElementById('planeToggle');
planeToggleBtn.addEventListener('click', () => {
  planesActive = !planesActive;
  if (planesActive) {
    startFlightsInterval();
    planeToggleBtn.textContent = 'Planes ON';
    planeToggleBtn.style.color = '#0ff';
    planeToggleBtn.classList.add('activeToggle');
  } else {
    stopFlightsInterval();
    planeToggleBtn.textContent = 'Planes OFF';
    planeToggleBtn.style.color = '#ff5555';
    planeToggleBtn.classList.remove('activeToggle');
  }
});

// Start on page load
startFlightsInterval();


    // -- Triangulation & Ruler logic --

    function distanceKm(latlng1, latlng2) {
      const R = 6371;
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(latlng2.lat - latlng1.lat);
      const dLon = toRad(latlng2.lng - latlng1.lng);
      const lat1 = toRad(latlng1.lat);
      const lat2 = toRad(latlng2.lat);
      const a = Math.sin(dLat/2)**2 + Math.sin(dLon/2)**2 * Math.cos(lat1) * Math.cos(lat2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function angleBetweenPoints(A, B, C) {
      function toVector(p1, p2) {
        return {x: p2.lng - p1.lng, y: p2.lat - p1.lat};
      }
      function dot(u,v) {
        return u.x*v.x + u.y*v.y;
      }
      function magnitude(v) {
        return Math.sqrt(v.x*v.x + v.y*v.y);
      }
      const BA = toVector(B, A);
      const BC = toVector(B, C);
      const cosAngle = dot(BA, BC) / (magnitude(BA) * magnitude(BC));
      const angleRad = Math.acos(Math.min(Math.max(cosAngle, -1), 1));
      return angleRad * (180 / Math.PI);
    }

    let triangPoints = [];
    let triangMarkers = [];
    let triangLines = [];

    let rulerStart = null;
    let rulerLine = null;

    const infoBox = document.getElementById('infoBox');
    const angleBox = document.getElementById('angleBox');
    const rulerBox = document.getElementById('rulerBox');

    let triangulateActive = false;
    let rulerActive = false;

    function clearTriangulation() {
      triangMarkers.forEach(m => map.removeLayer(m));
      triangLines.forEach(l => map.removeLayer(l));
      triangMarkers = [];
      triangLines = [];
      triangPoints = [];
      infoBox.textContent = 'Click 3 points to triangulate';
      angleBox.textContent = '';
    }

    function clearRuler() {
      if(rulerLine) {
        map.removeLayer(rulerLine);
        rulerLine = null;
      }
      rulerStart = null;
      rulerBox.textContent = 'Ruler: inactive';
    }

    function clearAll() {
      clearTriangulation();
      clearRuler();
    }

    function drawTriangLines() {
      for(let line of triangLines) {
        map.removeLayer(line);
      }
      triangLines = [];

      const [p1, p2, p3] = triangPoints;

      // Draw triangle edges
      triangLines.push(L.polyline([p1, p2], {color: '#0ff'}).addTo(map));
      triangLines.push(L.polyline([p2, p3], {color: '#0ff'}).addTo(map));
      triangLines.push(L.polyline([p3, p1], {color: '#0ff'}).addTo(map));
    }

    function updateTriangInfo() {
      if(triangPoints.length !== 3) return;

      const [p1, p2, p3] = triangPoints;

      // Distances (km)
      const d12 = distanceKm(p1, p2).toFixed(2);
      const d23 = distanceKm(p2, p3).toFixed(2);
      const d31 = distanceKm(p3, p1).toFixed(2);

      // Angles (degrees)
      const angle1 = angleBetweenPoints(p2, p1, p3).toFixed(1);
      const angle2 = angleBetweenPoints(p1, p2, p3).toFixed(1);
      const angle3 = angleBetweenPoints(p1, p3, p2).toFixed(1);

      infoBox.innerHTML = `
        <b>Triangle Sides (km):</b><br>
        P1-P2: ${d12}<br>
        P2-P3: ${d23}<br>
        P3-P1: ${d31}
      `;
      angleBox.innerHTML = `
        <b>Triangle Angles (°):</b><br>
        ∠P1: ${angle1}<br>
        ∠P2: ${angle2}<br>
        ∠P3: ${angle3}
      `;
    }

    function updateRulerLine(latlng) {
      if(!rulerStart) return;

      if(rulerLine) {
        rulerLine.setLatLngs([rulerStart, latlng]);
      } else {
        rulerLine = L.polyline([rulerStart, latlng], {color: '#0ff', dashArray: '5,10'}).addTo(map);
      }

      const dist = distanceKm(rulerStart, latlng).toFixed(2);
      rulerBox.textContent = `Ruler: ${dist} km`;
    }

    // Map click handler
    map.on('click', e => {
      if(triangulateActive) {
        if(triangPoints.length === 3) {
          clearTriangulation();
        }
        triangPoints.push(e.latlng);
        const marker = L.circleMarker(e.latlng, {
          radius: 7,
          color: '#0ff',
          weight: 2,
          fillColor: '#0ff',
          fillOpacity: 0.7
        }).addTo(map);
        triangMarkers.push(marker);

        if(triangPoints.length === 3) {
          drawTriangLines();
          updateTriangInfo();
        } else {
          infoBox.textContent = `Click ${3 - triangPoints.length} more point(s) to triangulate`;
          angleBox.textContent = '';
        }

        // Reset ruler if active
        if(rulerActive) {
          clearRuler();
          rulerActive = false;
          updateButtons();
        }

      } else if(rulerActive) {
        if(!rulerStart) {
          rulerStart = e.latlng;
          rulerBox.textContent = 'Ruler: click another point to measure distance';
          updateRulerLine(e.latlng);
        } else {
          updateRulerLine(e.latlng);
          rulerStart = null;
        }

        // Reset triang if active
        if(triangulateActive) {
          clearTriangulation();
          triangulateActive = false;
          updateButtons();
        }

      } else {
        // Neither mode active, do nothing
      }
    });

    // Update buttons UI
    function updateButtons() {
      planeToggleBtn.classList.toggle('activeToggle', planesActive);
      triangToggleBtn.classList.toggle('activeToggle', triangulateActive);
      rulerToggleBtn.classList.toggle('activeToggle', rulerActive);

      triangToggleBtn.textContent = triangulateActive ? 'Triangulate ON' : 'Triangulate OFF';
      rulerToggleBtn.textContent = rulerActive ? 'Ruler ON' : 'Ruler OFF';
    }

    // Toggle buttons handlers
    const triangToggleBtn = document.getElementById('triangToggle');
    const rulerToggleBtn = document.getElementById('rulerToggle');

    triangToggleBtn.addEventListener('click', () => {
      if(triangulateActive) {
        clearTriangulation();
        triangulateActive = false;
      } else {
        triangulateActive = true;
        rulerActive = false;
        clearRuler();
      }
      updateButtons();
    });

    rulerToggleBtn.addEventListener('click', () => {
      if(rulerActive) {
        clearRuler();
        rulerActive = false;
      } else {
        rulerActive = true;
        triangulateActive = false;
        clearTriangulation();
      }
      updateButtons();
    });

    // Reset all on 'r' key
    document.addEventListener('keydown', e => {
      if(e.key.toLowerCase() === 'r') {
        clearAll();
      }
    });

    updateButtons();

  </script>
</body>
</html>
